{"name":"AuditApp_Apps_Summary","query":"WITH AppSessionCounts AS (\n  SELECT  \n      aps.AppID,\n      COUNT(DISTINCT aps.SessionID) AS 'SessionCount'\n  FROM AppSessions AS aps\n  INNER JOIN Sessions AS ses ON aps.SessionID = ses.ID\n  GROUP BY aps.AppID\n),\nActivityCounts AS (\n    SELECT \n        aps.`AppID`,\n    \tCOUNT(*) 'AppActivityCount'\n    FROM AppActivityActionCalls aac\n    INNER JOIN `AppActivityActions` aaa ON aaa.ID = aac.`AppActivityActionID`\n    INNER JOIN `AppActivity` aa ON aa.`ID` = aaa.`AppActivityID`\n    INNER JOIN `AppSessions` aps ON aps.ID = aa.`AppSessionID`\n    LEFT JOIN AppActivityVsObjectMutations AAVOM ON AAVOM.AppActivityID = aa.ID\n    LEFT JOIN AppActivityVsMemberships AAVM ON AAVM.AppActivityID = aa.ID\n    WHERE COALESCE(AAVOM.ObjectMutationID, AAVM.MembershipID) IS NOT NULL\n    GROUP BY aps.`AppID`\n),\nErrorCounts AS (\nSELECT\n  app.ID,\n  COUNT(*) 'AppErrorCount'\nFROM\n  AppSessions AS aps\n  INNER JOIN Sessions AS ses ON aps.SessionID = ses.ID\n  INNER JOIN Users AS usr ON ses.UserID = usr.ID\n  INNER JOIN Apps AS app ON aps.AppID = app.ID\n  LEFT JOIN AppActivity AS apa ON aps.ID = apa.AppSessionID\n  LEFT JOIN AppFormUnits AS afu ON apa.AppFormUnitID = afu.ID\n  LEFT JOIN AppActivityActions AS apaa ON apa.ID = apaa.AppActivityID\n  LEFT JOIN AppActions AS apac ON apaa.AppActionID = apac.ID\n  LEFT JOIN AppActionTypes AS apat ON apac.AppActionTypeID = apat.ID\n  LEFT JOIN AppActivityActionCalls AS apaac ON apaa.ID = apaac.AppActivityActionID\n  LEFT JOIN AppResults AS apaac_apr ON apaac.AppResultID = apaac_apr.ID\n  LEFT JOIN AppErrorCodes AS apaac_apec ON apaac_apr.AppErrorCodeID = apaac_apec.ID\n  LEFT JOIN AppResults AS apa_apr ON (apa.AppResultID = apa_apr.ID AND apaac.AppActivityActionID IS NULL)\n  LEFT JOIN AppErrorCodes AS apa_apec ON apa_apr.AppErrorCodeID = apa_apec.ID\n  LEFT JOIN AppResults AS aps_apr ON (aps.AppResultID = aps_apr.ID AND apa.AppSessionID IS NULL)\n  LEFT JOIN AppErrorCodes AS aps_apec ON aps_apr.AppErrorCodeID = aps_apec.ID\nWHERE\n  COALESCE(apaac_apec.Error, apa_apec.Error, aps_apec.Error) <> 'success'\n  GROUP BY aps.AppID\n),\nPermissionCounts AS (\n  SELECT\n       GrpObj.`DisplayName` 'GroupName',\n       COUNT(*) 'PermissionActivityCount'\n  FROM\n  \tMemberships M\n      INNER JOIN Operations Op ON Op.ID = M.OperationID\n      INNER JOIN Activities AC ON AC.ID = M.ActivityID\n      INNER JOIN ActivityTypes AT ON AT.ID = AC.ActivityTypeID\n      INNER JOIN Objects GrpObj ON GrpObj.ID = M.GroupID\n      INNER JOIN SystemTables st ON st.ID = GrpObj.SystemTableID\n      INNER JOIN Objects MemObj ON MemObj.ID = M.MemberID\n      LEFT JOIN Users AS U ON U.ID = AC.UserID\n  WHERE st.`SystemName` = 'internal'\n  GROUP BY GrpObj.`DisplayName`\n)\nSELECT \n    Apps.`ID`\n  , Apps.`Name`\n  , COALESCE(SC.SessionCount, 0) AS 'Session Activity'\n  , COALESCE(AC.AppActivityCount, 0) AS 'Action Activity'\n  , COALESCE(ER.AppErrorCount, 0) AS 'Error Activity'\n  , COALESCE(PC.PermissionActivityCount, 0) AS 'Permission Activity'\nFROM Apps\nLEFT JOIN AppSessionCounts SC ON SC.AppID = Apps.ID\nLEFT JOIN ActivityCounts AC ON AC.AppID = Apps.ID\nLEFT JOIN ErrorCounts ER ON ER.ID = Apps.ID\nLEFT JOIN PermissionCounts PC ON PC.GroupName = ('nga_' || Apps.`Name`)\nORDER BY Apps.`Name`","params":[],"columns":[{"name":"ID","type":1},{"name":"Name","type":0},{"name":"Session Activity","type":0},{"name":"Action Activity","type":0},{"name":"Error Activity","type":0},{"name":"Permission Activity","type":0}]}